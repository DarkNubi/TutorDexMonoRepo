services:
  aggregator-ingest:
    build: ./TutorDexAggregator
    profiles: ["legacy"]
    env_file:
      - ./TutorDexAggregator/.env
    command: ["python", "runner.py", "start"]
    restart: unless-stopped
    volumes:
      - ./TutorDexAggregator:/app
      - ./TutorDexAggregator/logs:/app/logs
      - ./TutorDexAggregator/monitoring:/app/monitoring
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - supabase_net

  aggregator-worker:
    build: ./TutorDexAggregator
    env_file:
      - ./TutorDexAggregator/.env
    command: ["python", "workers/extract_worker.py"]
    restart: unless-stopped
    depends_on:
      - collector-tail
    volumes:
      - ./TutorDexAggregator:/app
      - ./TutorDexAggregator/logs:/app/logs
      - ./TutorDexAggregator/monitoring:/app/monitoring
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - supabase_net

  collector-tail:
    build: ./TutorDexAggregator
    env_file:
      - ./TutorDexAggregator/.env
    command: ["python", "collector.py", "tail"]
    restart: unless-stopped
    volumes:
      - ./TutorDexAggregator:/app
      - ./TutorDexAggregator/logs:/app/logs
      - ./TutorDexAggregator/monitoring:/app/monitoring
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - supabase_net

  aggregator-monitor:
    build: ./TutorDexAggregator
    env_file:
      - ./TutorDexAggregator/.env
    command: ["python", "monitoring/monitor.py"]
    restart: unless-stopped
    depends_on:
      - backend
    volumes:
      - ./TutorDexAggregator:/app
      - ./TutorDexAggregator/logs:/app/logs
      - ./TutorDexAggregator/monitoring:/app/monitoring
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - supabase_net

  backend:
    build: ./TutorDexBackend
    env_file:
      - ./TutorDexBackend/.env
    # Use the default CMD from TutorDexBackend/Dockerfile (uvicorn app:app)
    restart: unless-stopped
    ports:
      - "127.0.0.1:8000:8000"
    volumes:
      - ./TutorDexBackend/secrets/firebase-admin-service-account.json:/run/secrets/firebase-admin-service-account.json:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - supabase_net

  telegram-link-bot:
    build: ./TutorDexBackend
    env_file:
      - ./TutorDexBackend/.env
    environment:
      BACKEND_URL: http://backend:8000
      LINK_BOT_OFFSET_FILE: /state/telegram_link_bot_offset.json
    command: ["python", "TutorDexBackend/telegram_link_bot.py", "--poll-seconds", "2"]
    restart: unless-stopped
    depends_on:
      - backend
    volumes:
      - ./TutorDexBackend/secrets/firebase-admin-service-account.json:/run/secrets/firebase-admin-service-account.json:ro
      - telegram_link_bot_state:/state
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - supabase_net

  freshness-tiers:
    build: ./TutorDexAggregator
    env_file:
      - ./TutorDexAggregator/.env
    command:
      - sh
      - -c
      - |
        while true; do
          python update_freshness_tiers.py ${FRESHNESS_TIERS_ARGS:---expire-action closed --red-hours 336} || true
          sleep ${FRESHNESS_TIERS_INTERVAL_SECONDS:-3600}
        done
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - supabase_net

  tutorcity-fetch:
    build: ./TutorDexAggregator
    env_file:
      - ./TutorDexAggregator/.env
    command:
      - sh
      - -c
      - |
        while true; do
          python utilities/tutorcity_fetch.py --limit ${TUTORCITY_LIMIT:-50} || true
          sleep ${TUTORCITY_FETCH_INTERVAL_SECONDS:-300}
        done
    restart: unless-stopped
    volumes:
      - ./TutorDexAggregator:/app
      - ./TutorDexAggregator/logs:/app/logs
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - supabase_net

networks:
  supabase_net:
    external: true
    name: supabase_default

volumes:
  telegram_link_bot_state:
