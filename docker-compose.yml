services:
  aggregator-ingest:
    build: ./TutorDexAggregator
    env_file:
      - ./TutorDexAggregator/.env
    command: ["python", "runner.py", "start"]
    restart: unless-stopped
    volumes:
      - ./TutorDexAggregator:/app
      - ./TutorDexAggregator/logs:/app/logs
      - ./TutorDexAggregator/monitoring:/app/monitoring
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - supabase_net

  aggregator-worker:
    build: ./TutorDexAggregator
    env_file:
      - ./TutorDexAggregator/.env
    command: ["python", "workers/extract_worker.py"]
    restart: unless-stopped
    depends_on:
      - aggregator-ingest
    volumes:
      - ./TutorDexAggregator:/app
      - ./TutorDexAggregator/logs:/app/logs
      - ./TutorDexAggregator/monitoring:/app/monitoring
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - supabase_net

  aggregator-monitor:
    build: ./TutorDexAggregator
    env_file:
      - ./TutorDexAggregator/.env
    command: ["python", "monitoring/monitor.py"]
    restart: unless-stopped
    depends_on:
      - aggregator-ingest
    volumes:
      - ./TutorDexAggregator:/app
      - ./TutorDexAggregator/logs:/app/logs
      - ./TutorDexAggregator/monitoring:/app/monitoring
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - supabase_net

  backend:
    build: ./TutorDexBackend
    env_file:
      - ./TutorDexBackend/.env
    # Use the default CMD from TutorDexBackend/Dockerfile (uvicorn app:app)
    restart: unless-stopped
    ports:
      - "8000:8000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - supabase_net

  freshness-tiers:
    build: ./TutorDexAggregator
    env_file:
      - ./TutorDexAggregator/.env
    command:
      - sh
      - -c
      - |
        while true; do
          python update_freshness_tiers.py ${FRESHNESS_TIERS_ARGS:---expire-action closed --red-hours 336} || true
          sleep ${FRESHNESS_TIERS_INTERVAL_SECONDS:-3600}
        done
    restart: unless-stopped
    profiles: ["tiers"]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default
      - supabase_net

networks:
  supabase_net:
    external: true
    name: supabase_default
