<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tutor Profile Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              background: "hsl(var(--background))",
              foreground: "hsl(var(--foreground))",
              border: "hsl(var(--border))",
              card: "hsl(var(--card))",
              muted: "hsl(var(--muted))",
              "muted-foreground": "hsl(var(--muted-foreground))",
            },
          },
        },
      };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
      :root {
        --background: 0 0% 100%;
        --foreground: 222.2 84% 4.9%;
        --border: 214.3 31.8% 91.4%;
        --card: 0 0% 100%;
        --muted: 210 40% 96.1%;
        --muted-foreground: 215.4 16.3% 46.9%;
      }
      .dark {
        --background: 222.2 84% 4.9%;
        --foreground: 210 40% 98%;
        --border: 217.2 32.6% 17.5%;
        --card: 222.2 84% 4.9%;
        --muted: 217.2 32.6% 17.5%;
        --muted-foreground: 215 20.2% 65.1%;
      }
      body {
        font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: hsl(var(--background));
        color: hsl(var(--foreground));
      }
      h1,
      h2,
      h3,
      .brand-font {
        font-family: "Anton", sans-serif;
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }

      summary::-webkit-details-marker {
        display: none;
      }

      /* Custom Input Styling */
      .nike-input {
        width: 100%;
        padding: 1rem;
        border: 1px solid hsl(var(--border));
        font-weight: 500;
        transition: all 0.2s;
        outline: none;
        color: hsl(var(--foreground));
        background: hsl(var(--card));
        border-radius: 1rem;
      }
      .nike-input:focus {
        border-color: rgb(59, 130, 246);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.35);
      }
      .nike-input::placeholder {
        color: hsl(var(--muted-foreground));
        font-weight: 400;
      }

      /* Selection Button (Toggle) */
      .select-btn {
        border: 1px solid hsl(var(--border));
        transition: all 0.2s;
        background: hsl(var(--card));
        color: hsl(var(--foreground));
      }
      .select-btn:hover {
        border-color: rgb(59, 130, 246);
      }
      .select-btn.active {
        background: linear-gradient(135deg, rgb(37, 99, 235), rgb(79, 70, 229));
        color: white;
        border-color: rgb(59, 130, 246);
      }

      /* The Tray Logic */
      .tray-item {
        background: linear-gradient(135deg, rgb(37, 99, 235), rgb(79, 70, 229));
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 9999px; /* Pill */
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        font-weight: 600;
        animation: popIn 0.2s ease-out;
      }
      @keyframes popIn {
        0% {
          transform: scale(0.9);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body class="overflow-x-hidden bg-background text-foreground" data-require-auth="true">
    <nav
      class="flex justify-between items-center px-6 md:px-12 py-5 sticky top-0 bg-background/90 backdrop-blur z-50 border-b border-border transition duration-300"
    >
      <a href="index.html" class="flex items-center space-x-3" aria-label="Tutor Dex home">
        <img src="/TutorDex-icon-128.png" alt="TutorDex" class="w-10 h-10 rounded-lg object-contain" />
        <div class="text-2xl md:text-3xl brand-font tracking-tighter uppercase">Tutor Dex</div>
      </a>

      <div class="hidden md:flex space-x-8 font-bold text-sm uppercase tracking-wide">
        <a href="assignments.html" class="text-muted-foreground hover:text-foreground transition">Assignments</a>
        <a href="profile.html" class="text-foreground transition" aria-current="page">Profile</a>
      </div>

      <div class="flex items-center gap-3 text-sm font-bold uppercase">
        <details class="md:hidden relative">
          <summary class="list-none cursor-pointer select-none px-3 py-2 rounded-full hover:bg-muted/60 transition" aria-label="Open menu">
            <i class="fa-solid fa-bars text-lg"></i>
          </summary>
          <div class="absolute right-0 mt-3 w-56 bg-background border border-border rounded-xl shadow-lg p-2">
            <a href="assignments.html" class="block px-4 py-2 rounded-lg hover:bg-muted/60 transition">Assignments</a>
            <a href="profile.html" class="block px-4 py-2 rounded-lg hover:bg-muted/60 transition" aria-current="page">Profile</a>
          </div>
        </details>

        <button
          type="button"
          data-auth-logout
          class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-5 py-2 rounded-full hover:from-blue-700 hover:to-indigo-700 transition"
        >
          Log Out
        </button>
      </div>
    </nav>

    <div class="max-w-3xl mx-auto px-6 py-12">
      <div class="mb-12">
        <h1 class="text-5xl md:text-7xl leading-none mb-4">
          Build Your <br />
          Tutor Profile.
        </h1>
        <p class="text-lg font-medium text-muted-foreground max-w-lg">
          Complete your profile to get matched with the best-suited assignments in Singapore.
        </p>
      </div>

      <form id="profile-form">
        <section class="mb-16">
          <div class="flex justify-between items-end mb-6">
            <h2 class="text-2xl">01. Levels & Subjects</h2>
            <span class="text-xs font-bold text-muted-foreground uppercase tracking-widest">Multi-Select</span>
          </div>

          <div class="flex flex-wrap items-center gap-3 mb-4">
            <button
              id="check-match-counts"
              type="button"
              class="px-4 py-2 border border-border rounded-lg font-bold uppercase text-xs tracking-wide text-muted-foreground hover:text-foreground hover:border-blue-500 transition"
              title="Count open assignments in the last 7/14/30 days that match your current tray selections"
            >
              Check Recent Matches
            </button>
            <div id="match-counts-box" class="hidden text-sm text-muted-foreground">
              <span class="font-semibold">Matches (last</span>
              <span class="font-mono">7d:</span> <span id="match-count-7d" class="font-semibold">-</span>, <span class="font-mono">14d:</span>
              <span id="match-count-14d" class="font-semibold">-</span>, <span class="font-mono">30d:</span>
              <span id="match-count-30d" class="font-semibold">-</span>
              <span id="match-counts-note" class="text-xs text-muted-foreground ml-2"></span>
            </div>
          </div>

          <div class="bg-muted/40 p-6 rounded-2xl border border-border mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <select id="level-select" class="nike-input rounded-lg">
                <option value="" disabled selected>Select Level</option>
                <option value="Pre-School">Pre-School</option>
                <option value="Primary">Primary</option>
                <option value="Secondary">Secondary</option>
                <option value="IGCSE">IGCSE</option>
                <option value="IB">IB</option>
                <option value="Junior College">Junior College</option>
                <option value="Diploma">Diploma</option>
                <option value="Degree">Degree</option>
                <option value="Olympiads">Olympiads</option>
                <option value="Independent Learner - Languages">Independent Learner - Languages</option>
                <option value="Independent Learner - Computing">Independent Learner - Computing</option>
                <option value="Independent Learner - Music">Independent Learner - Music</option>
                <option value="Independent Learner - Others">Independent Learner - Others</option>
              </select>

              <select id="specific-level-select" class="nike-input rounded-lg" disabled>
                <option value="" selected>Select Specific Level (Optional)</option>
              </select>

              <div class="flex gap-3">
                <input id="subject-search" type="text" placeholder="Search subjects..." class="nike-input rounded-lg" autocomplete="off" />
                <button
                  id="clear-subject-search"
                  type="button"
                  class="px-4 py-2 border border-border rounded-lg font-bold uppercase text-xs tracking-wide text-muted-foreground hover:text-foreground hover:border-blue-500 transition"
                  title="Clear subject search"
                >
                  Clear
                </button>
              </div>
            </div>

            <div class="mb-2 flex items-center justify-between">
              <p class="text-xs text-muted-foreground">Select a level once, then click subjects to add combinations quickly.</p>
              <button
                id="clear-this-level"
                type="button"
                class="text-[11px] font-semibold px-2 py-1 border border-border rounded-full text-muted-foreground hover:text-foreground hover:bg-muted/60"
                title="Clear the level dropdown (does not remove added combinations)"
              >
                Clear level
              </button>
            </div>

            <div
              id="subject-buttons"
              class="w-full bg-background border border-border rounded-2xl p-3 flex flex-wrap gap-2 max-h-[220px] overflow-y-auto"
            >
              <span class="text-muted-foreground text-sm italic w-full text-center">Pick a level to see subjects…</span>
            </div>
          </div>

          <div class="flex items-center justify-between mb-3">
            <p class="text-xs font-bold text-muted-foreground uppercase tracking-widest">Added combinations</p>
            <div class="flex flex-wrap items-center gap-2">
              <button
                id="clear-tray"
                type="button"
                class="px-3 py-2 border border-border rounded-lg font-bold uppercase text-xs tracking-wide text-foreground hover:bg-muted/60 transition"
              >
                Clear All
              </button>
            </div>
          </div>

          <div id="subjects-tray" class="min-h-[80px] w-full border border-dashed border-border rounded-2xl p-4 flex flex-wrap gap-2 items-center">
            <span class="text-muted-foreground text-sm italic w-full text-center" id="empty-tray-msg"> Your added subjects will appear here... </span>
          </div>
        </section>

        <hr class="border-border mb-16" />

        <section class="mb-16">
          <h2 class="text-2xl mb-6">02. Where do you teach?</h2>
          <div id="teaching-locations" class="flex flex-wrap gap-3">
            <button type="button" class="select-btn rounded-full px-8 py-3 font-bold uppercase text-sm tracking-wide" onclick="toggleBtn(this)">
              North
            </button>
            <button type="button" class="select-btn rounded-full px-8 py-3 font-bold uppercase text-sm tracking-wide" onclick="toggleBtn(this)">
              North-east
            </button>
            <button type="button" class="select-btn rounded-full px-8 py-3 font-bold uppercase text-sm tracking-wide" onclick="toggleBtn(this)">
              East
            </button>
            <button type="button" class="select-btn rounded-full px-8 py-3 font-bold uppercase text-sm tracking-wide" onclick="toggleBtn(this)">
              Central
            </button>
            <button type="button" class="select-btn rounded-full px-8 py-3 font-bold uppercase text-sm tracking-wide" onclick="toggleBtn(this)">
              West
            </button>
            <button type="button" class="select-btn rounded-full px-8 py-3 font-bold uppercase text-sm tracking-wide" onclick="toggleBtn(this)">
              Online
            </button>
          </div>
          <div class="mt-6">
            <label class="block text-xs font-bold uppercase mb-2">Postal Code (Optional)</label>
            <input id="tutor-postal-code" type="text" inputmode="numeric" maxlength="6" placeholder="e.g. 560105" class="nike-input rounded-lg" />
            <p class="mt-2 text-xs text-muted-foreground">
              If set, in-person/hybrid DMs are filtered by distance. Leave blank to disable distance filtering.
            </p>
          </div>
          <div class="mt-6">
            <label class="block text-xs font-bold uppercase mb-2">DM Distance Radius (km)</label>
            <input id="dm-max-distance-km" type="number" min="0.5" max="50" step="0.5" placeholder="5" class="nike-input rounded-lg" />
            <p class="mt-2 text-xs text-muted-foreground">Defaults to 5km (min 0.5, max 50).</p>
          </div>
        </section>

        <hr class="border-border mb-16" />

        <section class="mb-16">
          <h2 class="text-2xl mb-6">03. Contact Details</h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div>
              <label class="block text-xs font-bold uppercase mb-2">Phone Number</label>
              <input id="contact-phone" type="tel" placeholder="+65" class="nike-input rounded-lg" />
            </div>
            <div>
              <label class="block text-xs font-bold uppercase mb-2">Email Address</label>
              <input id="contact-email" type="email" placeholder="you@example.com" class="nike-input rounded-lg" readonly aria-readonly="true" />
            </div>
            <div class="md:col-span-2">
              <div class="flex items-center justify-between mb-2">
                <label class="block text-xs font-bold uppercase"> Telegram Handle (Optional) </label>

                <button
                  type="button"
                  class="text-[11px] font-semibold px-2 py-1 border border-border rounded-full flex items-center gap-1 text-muted-foreground hover:text-foreground hover:bg-muted/60"
                  onclick="toggleInfo('telegram-info')"
                >
                  <i class="fa-solid fa-circle-info text-[12px]"></i>
                  Info
                </button>
              </div>

              <input id="contact-telegram-handle" type="text" placeholder="@username" class="nike-input rounded-lg" readonly aria-readonly="true" />

              <p id="telegram-info" class="mt-1 text-xs text-muted-foreground hidden">
                Auto-filled after you link Telegram DMs. If your Telegram account has no username, this will stay blank.
              </p>
            </div>
          </div>

          <div class="mb-8">
            <div class="flex items-center justify-between mb-2">
              <label class="block text-xs font-bold uppercase"> Telegram DMs </label>

              <button
                type="button"
                class="text-[11px] font-semibold px-2 py-1 border border-border rounded-full flex items-center gap-1 text-muted-foreground hover:text-foreground hover:bg-muted/60"
                onclick="toggleInfo('telegram-chatid-info')"
              >
                <i class="fa-solid fa-circle-info text-[12px]"></i>
                Info
              </button>
            </div>

            <p id="telegram-link-status" class="text-sm font-semibold text-muted-foreground">Checking link status...</p>

            <p id="telegram-chatid-info" class="mt-1 text-xs text-muted-foreground hidden">
              To receive DMs, generate a link code and send <span class="font-mono">/link &lt;code&gt;</span> to
              <a id="dm-bot-link" class="font-semibold underline" href="#" target="_blank" rel="noopener noreferrer">@TutorDexSniperBot</a>. Once
              linked, we will detect it automatically.
            </p>

            <div class="mt-3 flex flex-wrap items-center gap-3">
              <button
                id="generate-link-code"
                type="button"
                class="px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-bold uppercase text-xs tracking-wide hover:from-blue-700 hover:to-indigo-700 transition"
              >
                Generate Link Code
              </button>
              <div id="link-code-box" class="hidden flex flex-wrap items-center gap-2">
                <span class="text-xs font-bold uppercase text-muted-foreground">Code</span>
                <span id="link-code-display" class="text-sm font-mono text-foreground bg-muted/60 px-2 py-1 rounded"></span>
                <button
                  id="copy-link-command"
                  type="button"
                  class="text-xs font-bold uppercase underline text-muted-foreground hover:text-foreground"
                >
                  Copy /link
                </button>
                <a
                  id="open-dm-bot"
                  href="#"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-xs font-bold uppercase underline text-muted-foreground hover:text-foreground"
                  title="Open Telegram DM bot (uses /start payload)"
                >
                  Open bot
                </a>
              </div>
            </div>
            <p class="mt-2 text-xs text-muted-foreground">
              After generating a code, send <span class="font-mono">/link &lt;code&gt;</span> to
              <a id="dm-bot-link-2" class="font-semibold underline" href="#" target="_blank" rel="noopener noreferrer">@TutorDexSniperBot</a>
              (or click “Open bot”).
            </p>
          </div>
        </section>

        <p id="profile-save-status" class="text-sm font-medium text-muted-foreground mb-4"></p>
        <button
          type="submit"
          class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-5 rounded-full text-xl brand-font tracking-wide hover:from-blue-700 hover:to-indigo-700 transition transform hover:-translate-y-1"
        >
          Save Profile
        </button>
      </form>
    </div>

    <script type="module" src="/src/page-profile.js"></script>

    <p
      id="auth-init-error"
      class="hidden fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-[420px] bg-background border border-red-500/40 text-red-300 p-4 rounded-xl shadow-lg text-sm"
    >
      Authentication failed to initialize. If you're running locally, use `firebase emulators:start --only hosting`. If deployed, confirm Firebase
      Hosting is serving `__/firebase/init.js` and Auth is enabled.
    </p>

    <!-- @vite-ignore -->
    <script src="/__/firebase/10.14.1/firebase-app-compat.js"></script>
    <!-- @vite-ignore -->
    <script src="/__/firebase/10.14.1/firebase-auth-compat.js"></script>
    <!-- @vite-ignore -->
    <script src="/__/firebase/init.js"></script>
  </body>
</html>
