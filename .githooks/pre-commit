#!/bin/bash
# Pre-commit hook: Check for large files (>500 lines)
#
# This hook warns when committing files over 500 lines.
# Files over 500 lines should have a justification comment at the top explaining
# why they need to be large (e.g., "This file aggregates all API routes").
#
# To bypass this hook (not recommended): git commit --no-verify

# Color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîç Checking for large files (>500 lines)...${NC}"
echo ""

# Track if we found any large files
found_large_files=false

# Check Python files
large_python=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' | while read -r file; do
    if [ -f "$file" ]; then
        lines=$(wc -l < "$file")
        if [ "$lines" -gt 500 ]; then
            echo "$file:$lines"
        fi
    fi
done)

# Check TypeScript/JavaScript files
large_js=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | while read -r file; do
    if [ -f "$file" ]; then
        lines=$(wc -l < "$file")
        if [ "$lines" -gt 500 ]; then
            echo "$file:$lines"
        fi
    fi
done)

# Combine results
large_files=$(echo -e "$large_python\n$large_js" | grep -v '^$')

if [ -n "$large_files" ]; then
    found_large_files=true
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Large files detected in commit:${NC}"
    echo ""
    
    echo "$large_files" | while IFS=: read -r file lines; do
        echo -e "  ${RED}$file${NC}: ${YELLOW}$lines lines${NC}"
        
        # Check if file has justification comment
        if [ -f "$file" ]; then
            # Look for justification in first 10 lines
            justification=$(head -n 10 "$file" | grep -i -E '(justification|large file|big file|why.*large)' || true)
            if [ -z "$justification" ]; then
                echo -e "    ${RED}No justification comment found${NC}"
            else
                echo -e "    ${GREEN}‚úì Justification found${NC}"
            fi
        fi
    done
    
    echo ""
    echo -e "${YELLOW}üìã Large File Guidelines:${NC}"
    echo "  - Files >500 lines should have a justification comment at the top"
    echo "  - Example: # Large file justification: Aggregates all API routes"
    echo "  - Consider refactoring into smaller, focused modules"
    echo "  - If legitimate, ensure justification comment exists"
    echo ""
fi

# Check for files that are VERY large (>1000 lines)
very_large=$(echo "$large_files" | while IFS=: read -r file lines; do
    if [ "$lines" -gt 1000 ]; then
        echo "$file:$lines"
    fi
done)

if [ -n "$very_large" ]; then
    echo -e "${RED}‚ùå BLOCKING: Files over 1000 lines detected:${NC}"
    echo ""
    echo "$very_large" | while IFS=: read -r file lines; do
        echo -e "  ${RED}$file${NC}: ${RED}$lines lines${NC}"
    done
    echo ""
    echo -e "${RED}Files over 1000 lines must be refactored before committing.${NC}"
    echo "If this is a generated file, add it to .gitignore"
    echo "To bypass this check (NOT RECOMMENDED): git commit --no-verify"
    echo ""
    exit 1
fi

# If we found large files (500-1000), ask for confirmation
if [ "$found_large_files" = true ]; then
    echo -e "${YELLOW}Continue with commit?${NC} (y/n) "
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        echo ""
        echo -e "${BLUE}Commit cancelled. Please address large files before committing.${NC}"
        exit 1
    fi
fi

# Check passed
if [ "$found_large_files" = false ]; then
    echo -e "${GREEN}‚úÖ No large files detected${NC}"
fi

# Import linting (best-effort; requires `lint-imports` to be installed)
echo -e "${BLUE}üîç Running import-linter...${NC}"
if command -v lint-imports >/dev/null 2>&1; then
    if ! lint-imports --config .import-linter.ini; then
        echo -e "${RED}‚ùå Import linting failed${NC}"
        echo "Fix import boundary violations or run with --no-verify to skip"
        exit 1
    fi
    echo -e "${GREEN}‚úÖ Import linting passed${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Skipping import-linter (lint-imports not found).${NC}"
    echo "Install: pip install import-linter"
fi

echo ""
exit 0
