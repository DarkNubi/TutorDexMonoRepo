groups:
  - name: tutordex-infra
    rules:
      - alert: PrometheusTargetDown
        expr: up == 0
        for: 5m
        labels:
          severity: warning
          component: observability
        annotations:
          summary: "Prometheus scrape target down ({{ $labels.job }})"
          description: "Target {{ $labels.instance }} is down for {{ humanizeDuration $value }}."
          runbook: "observability/runbooks/PrometheusTargetDown.md"

      - alert: BlackboxProbeFailed
        expr: probe_success == 0
        for: 2m
        labels:
          severity: warning
          component: observability
        annotations:
          summary: "Health probe failed ({{ $labels.instance }})"
          description: "Blackbox probe failing for {{ $labels.instance }}."
          runbook: "observability/runbooks/BlackboxProbeFailed.md"

      - alert: HostDiskLow
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) < 0.10
        for: 15m
        labels:
          severity: warning
          component: infra
        annotations:
          summary: "Host disk low ({{ $labels.mountpoint }})"
          description: "Disk free < 10% on {{ $labels.mountpoint }} ({{ $labels.device }})."
          runbook: "observability/runbooks/HostDiskLow.md"

      - alert: ContainerRestarted
        expr: changes(container_start_time_seconds{container_label_com_docker_compose_service=~"collector-tail|aggregator-worker|backend|prometheus|alertmanager|loki|grafana"}[15m]) > 0
        for: 0m
        labels:
          severity: warning
          component: infra
        annotations:
          summary: "Container restarted ({{ $labels.container_label_com_docker_compose_service }})"
          description: "Service restarted within 15m (name={{ $labels.name }})."
          runbook: "observability/runbooks/ContainerRestarted.md"

  - name: tutordex-deadman
    rules:
      - alert: Watchdog
        expr: vector(1)
        for: 0m
        labels:
          severity: warning
          component: observability
        annotations:
          summary: "Watchdog (alerting pipeline test)"
          description: "This alert is always firing to validate Alertmanagerâ†’Telegram delivery."
          runbook: "observability/runbooks/Watchdog.md"

  - name: tutordex-pipeline
    rules:
      - alert: CollectorStalled
        # TEMP DISABLED: raw backfills / pauses can legitimately create gaps.
        # Re-enable by restoring the original expression.
        expr: vector(0)
        for: 10m
        labels:
          severity: warning
          component: collector
        annotations:
          summary: "Collector stalled ({{ $labels.channel }})"
          description: "No messages for {{ humanizeDuration $value }} (pipeline={{ $labels.pipeline_version }}, schema={{ $labels.schema_version }})"
          runbook: "observability/runbooks/CollectorStalled.md"

      - alert: QueueBacklogGrowingNoThroughput
        expr: (delta(queue_pending[15m]) > 0) and on(pipeline_version, schema_version) (sum by (pipeline_version, schema_version) (rate(worker_jobs_processed_total[5m])) == 0)
        for: 10m
        labels:
          severity: critical
          component: queue
        annotations:
          summary: "Queue backlog growing with zero throughput"
          description: "pending increased over 15m and worker throughput is 0 (pipeline={{ $labels.pipeline_version }}, schema={{ $labels.schema_version }})"
          runbook: "observability/runbooks/QueueBacklogGrowingNoThroughput.md"

      - alert: QueueOldestPendingTooOld
        expr: queue_oldest_pending_age_seconds > 1800
        for: 10m
        labels:
          severity: warning
          component: queue
        annotations:
          summary: "Oldest pending job too old"
          description: "oldest pending age={{ humanizeDuration $value }} (pipeline={{ $labels.pipeline_version }}, schema={{ $labels.schema_version }})"
          runbook: "observability/runbooks/QueueOldestPendingTooOld.md"

      - alert: QueueStuckProcessing
        expr: queue_oldest_processing_age_seconds > 900
        for: 5m
        labels:
          severity: critical
          component: queue
        annotations:
          summary: "Jobs stuck in processing"
          description: "oldest processing age={{ humanizeDuration $value }} (pipeline={{ $labels.pipeline_version }}, schema={{ $labels.schema_version }})"
          runbook: "observability/runbooks/QueueStuckProcessing.md"

      - alert: LLMFailureSpike
        expr: rate(worker_llm_fail_total[5m]) > 0.2
        for: 5m
        labels:
          severity: warning
          component: worker
        annotations:
          summary: "LLM failures spiking"
          description: "LLM fail rate={{ $value | humanize }} /s (pipeline={{ $labels.pipeline_version }}, schema={{ $labels.schema_version }})"
          runbook: "observability/runbooks/LLMFailureSpike.md"

      - alert: SupabaseFailureSpike
        expr: sum by (operation, pipeline_version, schema_version) (rate(worker_supabase_fail_total[5m])) > 0.2
        for: 5m
        labels:
          severity: warning
          component: worker
        annotations:
          summary: "Supabase failures spiking ({{ $labels.operation }})"
          description: "Supabase fail rate={{ $value | humanize }} /s (pipeline={{ $labels.pipeline_version }}, schema={{ $labels.schema_version }})"
          runbook: "observability/runbooks/SupabaseFailureSpike.md"

      - alert: BroadcastFailureSpike
        expr: rate(broadcast_fail_total[5m]) > 0.2
        for: 5m
        labels:
          severity: warning
          component: broadcast
        annotations:
          summary: "Broadcast failures spiking"
          description: "Broadcast fail rate={{ $value | humanize }} /s (pipeline={{ $labels.pipeline_version }}, schema={{ $labels.schema_version }})"
          runbook: "observability/runbooks/BroadcastFailureSpike.md"

      - alert: DMFailureSpike
        expr: rate(dm_fail_total[5m]) > 0.2
        for: 5m
        labels:
          severity: warning
          component: dm
        annotations:
          summary: "DM failures spiking"
          description: "DM fail rate={{ $value | humanize }} /s (pipeline={{ $labels.pipeline_version }}, schema={{ $labels.schema_version }})"
          runbook: "observability/runbooks/DMFailureSpike.md"

      - alert: DMRateLimited
        expr: rate(dm_rate_limited_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
          component: dm
        annotations:
          summary: "DM rate-limited"
          description: "Rate limits observed (rate={{ $value | humanize }} /s) (pipeline={{ $labels.pipeline_version }}, schema={{ $labels.schema_version }})"
          runbook: "observability/runbooks/DMRateLimited.md"

  - name: tutordex-quality
    rules:
      - alert: ParseFailureSpike
        expr: sum(rate(worker_parse_failure_total[10m])) > 0.5
        for: 5m
        labels:
          severity: warning
          component: worker
        annotations:
          summary: "Parse failures spiking"
          description: "Parse failure rate={{ $value | humanize }} /s (see reasons via worker_parse_failure_total{reason=...})."
          runbook: "observability/runbooks/ParseFailureSpike.md"

      - alert: ParseErrorFractionHigh
        expr: tutordex:worker:parse_error_fraction > 0.20
        for: 10m
        labels:
          severity: warning
          component: worker
        annotations:
          summary: "High parse error fraction"
          description: "Over last 10m, >20% of attempts are failing."
          runbook: "observability/runbooks/ParseErrorFractionHigh.md"

      - alert: MissingSubjectsHigh
        expr: sum(rate(assignment_quality_missing_field_total{field="signals_subjects"}[30m])) > 0.2
        for: 15m
        labels:
          severity: warning
          component: quality
        annotations:
          summary: "Assignments missing subjects (signals)"
          description: "Missing subjects rate is elevated; check LLM output or subject matcher changes."
          runbook: "observability/runbooks/MissingSubjectsHigh.md"
