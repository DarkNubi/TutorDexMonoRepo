name: Deploy via Tailscale SSH

on:
  push:
    branches: [ "main" ]   # change if needed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Deploy to Windows server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_TS_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script_stop: true
          script: |
            powershell -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command "$ErrorActionPreference = 'Stop'; Set-StrictMode -Version Latest; Set-Location -LiteralPath '${{ secrets.SERVER_PATH }}'; git pull --ff-only; git rev-parse --short HEAD; if (Test-Path 'TutorDexBackend/docker-compose.backend.yml') { try { docker compose -f 'TutorDexBackend/docker-compose.backend.yml' down --remove-orphans } catch { } }; try { docker rm -f tutordex-backend-api tutordex-backend-telegram-link-bot 2>$null } catch { }; docker compose -f docker-compose.yml version; docker compose -f docker-compose.yml up -d --build --force-recreate --remove-orphans; docker compose -f docker-compose.yml ps"
